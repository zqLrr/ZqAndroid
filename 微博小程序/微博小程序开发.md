# 微博小程序开发

## 1、准备

* 环境  node.js
* IDE  [下载微博小程序IDE WBox Studio](http://mini.lite.weibo.cn/mpide/download?ps=Mac)

## 2、创建

* 前提：appId  在微博开发平台进行注册，但是有测试appid
* 新建，有四个模版可供选择
* 前端知识：
  * css
  * Vue.js

## 3、开发注意要点

* Vue 语法

  * 不支持DOM操作
  * 不支持BOM操作

* window 对象，如果想要获取screen信息，使用

  * WBXEnvironment
    * appVersion: 微博版本
    * platform: Android/iOS
    * runtimeVersion: 小程序的Runtime版本
    * deviceWidth: 设备宽度
    * deviceHeight: 设备高度

* history,location,navigator对象

  使用 wbx.navigateTo/navigateBack等api替换

* 只含有运行时的编译版本
  * 定义组件时不支持 [template](https://cn.vuejs.org/v2/api/?spm=a2c7j.-zh-guide-use-vue-in-weex.0.0.782839ed2b58by#template) 选项。 不支持使用 [x-templates](https://cn.vuejs.org/v2/guide/components.html?spm=a2c7j.-zh-guide-use-vue-in-weex.0.0.782839ed2b58by#X-Templates)。 不支持使用 [Vue.compile](https://cn.vuejs.org/v2/api/?spm=a2c7j.-zh-guide-use-vue-in-weex.0.0.782839ed2b58by#Vue-compile)。

* 全局组件注册

  Vue在Web中，通过Vue-router等组件，申明为单页面应用程序，此时，Vue在页面内只有一个实例，因此，可以将某个组件只注册一次，就能在全局使用（通过 Vue.component ) WBox会为每一个页面单独创建一个Vue实例，因此在WBox环境中，如果希望注册全局组件，需要通过 app.js中的 beforeCreatePage 生命周期实现。

* 国际化 

  需要按照开发文档，新建`src/config.json`文件，并按照文档进行函数配置

* 样式

  * 文件的page.css在app.css之后引入
  * 引用的组件的css会自动合并到page.css

* VueRouter的移植

  * 需要先了解VueRouter

* Vuex

  可使用`@wbox/wbx-vuex`替代`vuex`,为了共享全局变量

  这个也需要了解一下

* 网络请求

  ```javascript
  wbx.request({
      url:'https://www.weibo.com',
      sucess(res) {
          // handle data
          console.log(res.data)
      },
      fail(res) {
          console.log('error')
      }
  })
  ```

* Cookie

  微博不支持，使用wbx.request的header字段自定义其他header头实现代替

* es6语法

  Promise/Proxy暂不支持。

* 操作Dom的微博小程序运行流程

  Service->Render 的运行

根据以上流程，Vue中的事件修饰符，除 .capture 与.passive之外，都不可以用，但是为了实现prevent/stop/self功能，我们自定义了 ~ 符号做为修饰符。（需要了解Vue的事件修饰符）

```
复制<view @click~self="handleClick"/>
<view @click~stop="handleStop"/>
```

## 4、微博小程序App

### 4.1 生命周期

#### onLaunch(object)

页面加载时触发。一个页面只会调用一次，可以在 onLaunch 的参数中获取打开当前页面路径中的参数。

##### 参数说明

| 名称  | 类型   | 说明                                                         |
| :---- | :----- | :----------------------------------------------------------- |
| query | Object | 启动小程序的时候通过[小程序scheme](http://wbox.client.weibo.cn/docs/scheme)会传入的参数 |

#### onShow(object)

页面显示/切入前台时触发。

#### onHide()

页面隐藏/切入后台时触发。 如 navigateTo 或底部 tab 切换到其他页面，小程序切入后台等。

#### onUnload()

页面卸载时触发。如 redirectTo 或 navigateBack 到其他页面时。

#### beforeCreatePage()

页面即将创建时触发。此处可以配置需要全局注册的Vue组件

#### onThemeChange(options)

暗黑模式切换时将会触发。[详见](http://wbox.client.weibo.cn/docs/darkmode)如何使用暗黑模式。注意：自SDK version 22之后，才支持该函数

#### onMemoryWarning(options)

**最低SDK版本:39**

监听内存不足告警事件 当iOS/Android向小程序进程发出内存警告时，触发该事件。 触发该事件不意味小程序被杀，开发者可在收到通知后回收一些不必要资源避免进一步加剧内存紧张。 如果频繁触发或触发严重等级，小程序会主动弹框，用户点击确认后终止小程序。

回调参数 options

| 属性  | 类型   | 说明                                        | 最低版本 |
| :---- | :----- | :------------------------------------------ | :------- |
| level | number | 内存告警级别（仅Android有），对应系统宏定义 | 39       |

level的合法值

| 值   | 说明                         | 最低版本 |
| :--- | :--------------------------- | :------- |
| 5    | TRIM_MEMORY_RUNNING_MODERATE | 39       |
| 10   | TRIM_MEMORY_RUNNING_LOW      | 39       |
| 15   | TRIM_MEMORY_RUNNING_CRITICAL | 39       |

### 4.2 全局配置 —— app.json

| 属性名     | 类型           | 必填 | 说明                   | 最低版本 |
| :--------- | :------------- | :--- | :--------------------- | :------- |
| pages      | Array\<String> | 是   | 页面路径列表           |          |
| window     | Object         | 否   | 全局的默认窗口表现     |          |
| tabBar     | Object         | 否   | 底部 tab 栏的表现      |          |
| swipeBar   | Object         | 否   | 顶部 swipeBar 栏的表现 |          |
| renderType | Number         | 否   | 渲染方式               |          |
| autoRotate | bool           | 否   | 支持小程序转屏         |          |

*  添加界面的时候，要在pages中添加页面的配置

  ```javascript
  "pages": ["pages/usage/usage", "pages/image/image"]
  ```

### 4.3  页面配置 —— page.json

[配置参数界面](http://wbox.client.weibo.cn/docs/page-json/)

* 沉浸式 **试了一下无法实现**

  配置页面pagemode : 2 ,添加css代码

  ```css
  body{
    height: auto !important;
  }
  ```

## 5、WBUI

### 5.1 引入方式

* 整体引入（暂时没有实现）

  - 打开 WBox Studio，快捷键`COMMAND + SHIFT + P`
  - 输入`WBox: Add Render Plugin`，回车
  - 选择线上插件
  - 选择`@wbox/wb-ui`,等待自动配置完成
  - 在当前小程序根目录下，执行`npm install`
  - 安装完成
  - 在app.js 引入`import '@wbox/wb-ui/dist/css/index.css'`

* 部分引入(引入组件的方式和其类似)

  * npm install @wbox/wb-ui

  * 全局配置

    * app.js

      ```javascript
      import '@wbox/wb-ui/dist/css/base.css'
      ```

    * app.json(若是多个页面需要可以添加在此处)

  * 页面配置

    * page.vue

      ```js
      import '@wbox/wb-ui/dist/css/topBar.css'
      ```

    * page.json

      ```javascript
       "externalJSFileNameList": [
          // 当前为按需引入的js的require路径
          "wb-ui/dist/topBar",
        ]
      ```

